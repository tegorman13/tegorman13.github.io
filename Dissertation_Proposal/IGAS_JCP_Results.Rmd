---
title: "MotorLearn_PosterPlots"
output: pdf_document
---


# load relevant data
```{r, include=FALSE, echo=FALSE}
source('IGAS_ProcessFunctions.R')

#rm(list=ls())
###### data loading and organization #######

# load the processed data from experiment 1 and 2
e1 <- readRDS("data/igas_e1_cleanedData-final.rds")%>% mutate(initialVelocityX=X_Velocity,initialVelocityY=Y_Velocity,stageInt=as.numeric(as.character(experimentStage)))
e2<- readRDS('data/igas_e2_cleanedData-final.rds')%>% mutate(initialVelocityX=X_Velocity,initialVelocityY=Y_Velocity)
# load subject similarity data - computed with the IGAS model in 'IGAS-SimModel.R'
e2_sim <- readRDS('data/IGAS_Similarity-Performance.rds')

options(contrasts = c("contr.sum", "contr.poly"))
defaultContrasts = options()$contrasts
theme_set(theme_classic())

dodge <- position_dodge(width = 0.9)
e2GrpPos <- c("400","500","625","675","800","900")
e2Grp <- paste("Constant","Constant", "Constant","Constant","Constant","Constant", "Varied")
e2Labels <- paste(c("400\n Constant","500\n Constant","625\n Constant","675\n Constant",
                   "800\n Constant","900\n Constant","500-800\n Varied"),sep="")

e1Pos <- c("610","760","835","910")
e1Var <- paste("Varied Train Position","Constant Train Position", "Novel Position", "Varied Training Position")
e1Labels<- paste(c("610\n Varied Trained","760\n Constant Trained","835\n Novel Location","910\n Varied Trained"),sep="")
```

## Experiment 1 


# Training - Experiment 1
```{r}

exp1TrainPosition <- e1 %>% filter(stage!="Transfer",mode==1) %>%ungroup() %>% 
  group_by(sbjCode,Group,conditType,trainHalf,positionX) %>% 
  summarise(MeanTargetDistance=mean(AbsDistFromCenter))

exp1TrainPosition3 <- e1 %>% filter(stage!="Transfer",mode==1) %>%ungroup() %>% 
  group_by(sbjCode,Group,conditType,stage,positionX) %>% 
  summarise(MeanTargetDistance=mean(AbsDistFromCenter))

exp1Train <- e1 %>% filter(stage!="Transfer",mode==1)  %>%
  group_by(sbjCode,Group,conditType,trainHalf) %>% summarise(MeanTargetDistance=mean(AbsDistFromCenter))

exp1Train3 <- e1 %>% filter(stage!="Transfer",mode==1)  %>%
  group_by(sbjCode,Group,conditType,stage) %>% summarise(MeanTargetDistance=mean(AbsDistFromCenter))
# 
# exp1TrainPosition %>% ggplot(aes(x=trainHalf,y=MeanTargetDistance))+
#   geom_bar(aes(group=positionX,fill=positionX),stat="summary",fun=mean,position=dodge)+
#   facet_wrap(~conditType,ncol=2)+
#   stat_summary(aes(x=trainHalf,group=positionX),fun.data=mean_se,geom="errorbar",position=dodge,width=.8)+
#   ylab("Mean Distance From Center Of Target")+
#   xlab("Training Stage")+theme(plot.title = element_text(hjust = 0.5))+
#   guides(fill=guide_legend(title="Throw Location"))+theme(legend.title.align=.25)

# 
exp1TrainPosition %>% ggplot(aes(x=positionX,y=MeanTargetDistance))+
  geom_bar(aes(group=trainHalf,fill=trainHalf),stat="summary",fun=mean,position=dodge)+
  facet_wrap(~conditType,ncol=2)+
  stat_summary(aes(x=positionX,group=trainHalf),fun.data=mean_se,geom="errorbar",position=dodge,width=.8)+
  ylab("Mean Distance From Center Of Target")+
  xlab("Training Location(s)")+theme(plot.title = element_text(hjust = 0.5))+
  guides(fill=guide_legend(title="Training Stage"))+theme(legend.title.align=.25)

exp1TrainPosition3 %>% ggplot(aes(x=positionX,y=MeanTargetDistance))+
  geom_bar(aes(group=stage,fill=stage),stat="summary",fun=mean,position=dodge)+
  facet_wrap(~conditType,ncol=2)+
  stat_summary(aes(x=positionX,group=stage),fun.data=mean_se,geom="errorbar",position=dodge,width=.8)+
  ylab("Mean Distance From Center Of Target")+
  xlab("Training Location(s)")+theme(plot.title = element_text(hjust = 0.5))+
  guides(fill=guide_legend(title="Training Stage"))+theme(legend.title.align=.25)




# original - train split into 2 halves
model<-ezANOVA(exp1Train,dv=MeanTargetDistance,within=c(trainHalf),between=Group,wid=sbjCode,type=3);show(model)

# train split into thirds
ezANOVA(exp1Train3,dv=MeanTargetDistance,within=c(stage),between=Group,wid=sbjCode,type=3) %>% show()



aggregate(MeanTargetDistance ~ conditType + positionX,data=exp1TrainPosition,mean)
describeBy(exp1TrainPosition[,c("MeanTargetDistance","conditType")],exp1TrainPosition$conditType)
column.labels=c("Training Condition","Training Stage","Throw Position","Mean","Sd")
                            
```








# Experimenet 1 - intermittent testing - in original JCP submission
```{r,fig.width=13}
# first 3 trials - 1 throw from 610, 760 and 910
# interleaved every 20 trials, 2 throws from 610, 760, 910
# 10 full intermittent tests (6 trials each), plus 3 at beginning = 63 total per subject. 
#[1] 0  2  3  5  6  8  9  11 12 14 15 17 18 20 21 23 24 26 27 29 30
# First final testing trial is 264. So 1-263 = training and intermittent testing. 
# 
# intTest.third <- exp1.inter %>% filter(intStage!="int1")%>% group_by(sbjCode,conditType,stage,intStage,positionX) %>%
#   summarise(MeanTargetDistance=mean(AbsDistFromCenter,trim=.05)) %>% group_by(sbjCode,conditType,stage,positionX) %>%
#   summarise(MeanTargetDistance=mean(MeanTargetDistance))
# 
# intTest.third %>% ggplot(aes(x=positionX,y=MeanTargetDistance))+
#   geom_bar(aes(group=stage,fill=stage),stat="summary",fun=mean,position=dodge)+
#   facet_wrap(~conditType,ncol=2)+
#   stat_summary(aes(x=positionX,group=stage),fun.data=mean_se,geom="errorbar",position=dodge,width=.8)+
#   ylab("Mean Distance From Center Of Target")+
#   xlab("Throw Location")+theme(plot.title = element_text(hjust = 0.5))+
#   guides(fill=guide_legend(title="Training Stage"))+theme(legend.title.align=.25)
# 
# intTest.half %>% anova_test(dv=MeanTargetDistance,between=conditType,within=trainHalf,covariate=positionX,wid=sbjCode)
# intTest.half %>% anova_test(dv=MeanTargetDistance,between=conditType,within=c(trainHalf,positionX),wid=sbjCode)

#0  1  2  3  4  5  6  7  8  9  10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 31 29 30



intTest.half <- readRDS("data/e1_intTest.rds")


intTest.half <- exp1.inter %>%filter(AbsDistFromCenter<1550)%>%
  group_by(sbjCode,conditType,trainHalf,positionX) %>%
  summarise(MeanTargetDistance=mean(AbsDistFromCenter,trim=.01))


intTest.half %>% ggplot(aes(x=positionX,y=MeanTargetDistance))+
  geom_bar(aes(group=trainHalf,fill=trainHalf),stat="summary",fun=mean,position=dodge)+
  facet_wrap(~conditType,ncol=2)+
  stat_summary(aes(x=positionX,group=trainHalf),fun.data=mean_se,geom="errorbar",position=dodge,width=.8)+
  ylab("Mean Distance From Center Of Target")+
  xlab("Intermittent Testing Throw Location")+theme(plot.title = element_text(hjust = 0.5))+
  guides(fill=guide_legend(title="Training Stage"))+theme(legend.title.align=.25)




#trainTransferStages <- c(1,4,7,10,13,16,19,22,25,28,31)
stageCuts <- c(8,18,32)
exp1.inter <- e1 %>% filter(mode==0) %>%ungroup() %>%  group_by(sbjCode,positionX) %>%
  mutate(ind=1,testPosIndex=cumsum(ind),posN=max(testPosIndex),
         intStage=case_when(stageInt<stageCuts[1] ~"Beginning",stageInt<stageCuts[2] ~"Middle",stageInt<stageCuts[3] ~"End" )) %>%
  dplyr::select(-ind)%>% as.data.frame()
exp1.inter$intStage <- factor(exp1.inter$intStage,levels=c("Beginning","Middle","End"))

cnames=c("Condition","610_First Half","760_First Half","910_First Half","610_Second Half","760_Second Half","910_Second Half")
test= intTest.half %>% rename(Condition="conditType") %>% group_by(Condition,trainHalf,positionX) %>%
  summarise(Mean=round(mean(MeanTargetDistance),2),sd=round(sd(MeanTargetDistance),2))
test=test %>% group_by(Condition) %>% mutate(msd=paste(Mean,"(",sd,")",sep="")) %>%
 select(Condition,positionX,trainHalf,msd)%>% pivot_wider(names_from = c(positionX,trainHalf),values_from=c(msd))
test=test %>% as.data.frame()
colnames(test) <- cnames
stargazer(test,type="text",summary=FALSE,rownames=FALSE)

 #0  1  2  3  4  5  6  7  8  9  10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 31 29 30

# int <- e1 %>% filter(mode==0)
# #trainTransferStages <- unique(e1$experimentStage)
# stageCuts <- c(9,20,32)
# exp1.inter <- e1 %>% filter(mode==0) %>%ungroup() %>%  group_by(sbjCode,positionX) %>%
#   mutate(ind=1,testPosIndex=cumsum(ind),posN=max(testPosIndex),
#          intStage=case_when(stageInt<stageCuts[1] ~"Beginning",stageInt<stageCuts[2] ~"Middle",
#                            stageInt<stageCuts[3] ~"End" )) %>%
#   dplyr::select(-ind)%>% as.data.frame()
# exp1.inter$intStage <- factor(exp1.inter$intStage,levels=c("Beginning","Middle","End"))
# 
# #thirds
# intTest.thirds <- exp1.inter %>%filter(stageInt>2,AbsDistFromCenter<2050)%>% 
#   group_by(sbjCode,conditType,intStage,positionX) %>%
#   summarise(MeanTargetDistance=mean(AbsDistFromCenter,trim=.01))
# 
# intTest.thirds %>% ggplot(aes(x=positionX,y=MeanTargetDistance,
#                               group=conditType,fill=conditType))+
#   stat_summary(fun=mean,geom="bar",position=dodge)+
#   stat_summary(fun.data=mean_se,geom="errorbar",position=dodge,width=.8)+
#   facet_wrap(~intStage,ncol=3)+
#   ylab("Mean Distance From Center Of Target")+
#   xlab("Intermittent Testing Throw Location")+theme(plot.title = element_text(hjust = 0.5))+
#   guides(fill=guide_legend(title="Training Stage"))+theme(legend.title.align=.25)
# 
# 




#bins
# intTest.bins <- exp1.inter %>%filter(stageInt>0,AbsDistFromCenter<1550)%>% 
#   group_by(sbjCode,conditType,experimentStage,positionX) %>%
#   summarise(MeanTargetDistance=mean(AbsDistFromCenter,trim=.001))
# 
# intTest.bins %>% ggplot(aes(x=experimentStage,y=MeanTargetDistance,
#                               group=conditType,fill=conditType))+
#   stat_summary(fun=mean,geom="bar",position=dodge)+
#   stat_summary(fun.data=mean_se,geom="errorbar",position=dodge,width=.8)+
#   facet_wrap(~positionX,ncol=3)+
#   ylab("Mean Distance From Center Of Target")+
#   xlab("Intermittent Testing Throw Location")+theme(plot.title = element_text(hjust = 0.5))+
#   guides(fill=guide_legend(title="Training Stage"))+theme(legend.title.align=.25)




```





#Experiment 1 Testing Phase
```{r}

exp1.Test <- e1 %>% filter(stage=="Transfer") %>% select(-trainHalf)%>% group_by(positionX) %>% 
  mutate(globalAvg=mean(AbsDistFromCenter),globalSd=sd(AbsDistFromCenter)) %>% 
  group_by(sbjCode,positionX) %>% 
  mutate(scaledDev = scaleVar(globalAvg,globalSd,AbsDistFromCenter)) %>%
  ungroup() %>% group_by(sbjCode,conditType,positionX,ThrowPosition) %>%
summarise(MeanTargetDeviance = mean(AbsDistFromCenter),MeanScaleDev = mean(scaledDev),.groups="keep")%>% as.data.frame()

exp1.Test2 <- exp1.Test %>% group_by(sbjCode,conditType) %>% 
  summarise(MeanTargetDeviance = mean(MeanTargetDeviance),MeanScaleDev = mean(MeanScaleDev),.groups="keep")%>% as.data.frame()

#manuscript plot
exp1.Test %>% ggplot(aes(x=positionX,y=MeanTargetDeviance,group=conditType,fill=conditType))+
  geom_bar(stat="summary",fun=mean,position=dodge)+ stat_summary(fun.data=mean_se,geom="errorbar",position=dodge,width=.5)+ylab("Mean Distance From Center Of Target") +xlab("Testing Location")+theme(plot.title = element_text(hjust = 0.5))+guides(fill=guide_legend(title="Training Condition"))+theme(legend.title.align=.25)+scale_x_discrete(name="Testing Location",labels=e1Labels)

m1 <- exp1.Test %>% anova_test(dv=MeanTargetDeviance,between=conditType,within=positionX,wid=sbjCode,type=3); show(m1)

m2 <- exp1.Test2 %>% anova_test(dv=MeanScaleDev,between=conditType,wid=sbjCode,type=3); show(m2)

# model<-ezANOVA(data=exp1.Test,dv=MeanTargetDeviance,within=c(positionX),between=c(conditType),wid=sbjCode,type=3) 
# mm1 <- exp1.Test %>% lmer(MeanTargetDeviance ~ conditType + (1|positionX),data=.)
# mm1 <- exp1.Test %>% lmer(MeanTargetDeviance ~ conditType + (1|sbjCode)+(1|positionX),data=.)

t=e1 %>% filter(stage=="Transfer")  %>% group_by(conditType,positionX) %>% 
  summarise(Mean=round(mean(AbsDistFromCenter),2),sd=round(sd(AbsDistFromCenter),2),msd=paste(Mean,"(",sd,")",sep=""),.groups="keep") %>%
   select(-Mean,-sd) %>% spread(positionX,msd) %>% as.data.frame() %>%stargazer(.,type="text",summary=FALSE,rownames = FALSE)



cnames=c("Condition","610","760","835","910","")
test= exp1.Test %>% rename(Condition="conditType") %>% group_by(Condition,positionX) %>% 
  summarise(Mean=round(mean(MeanTargetDeviance),2),sd=round(sd(MeanTargetDeviance),2)) 
test=test %>% group_by(Condition) %>% mutate(GroupAvg=round(mean(Mean),2),groupSd=round(sd(Mean),2))
test = test %>% mutate(msd=paste(Mean,"(",sd,")",sep=""),gsd=paste(GroupAvg,"(",groupSd,")",sep="")) %>% select(Condition,positionX,msd,gsd)%>%pivot_wider(names_from = positionX,values_from=c(msd,gsd))
test=test[,1:6] %>% as.data.frame()
colnames(test) <- cnames
stargazer(test,type="text",summary=FALSE,rownames=FALSE)




tukey_e1 <- exp1.Test %>% group_by(positionX) %>%tukey_hsd(MeanTargetDeviance~conditType,detailed=TRUE,p.adjust.method = "holm")

tukey_e1 %>% select(-null.value,-group1,-group2,-p.adj.signif)


tt <-  exp1.Test %>% group_by(positionX)%>% t_test(MeanTargetDeviance~conditType); show(tt)


```

# Experiment 1 Identity Contrast (760) and novel position contrast (835)
```{r}
exp1.Test %>% group_by(positionX) %>% welch_anova_test(MeanTargetDeviance~conditType) 
exp1.Test %>% group_by(positionX) %>% emmeans_test(MeanTargetDeviance~conditType,p.adjust.method = "bonferroni",detailed=TRUE)
exp1.Test %>% group_by(positionX) %>%games_howell_test(MeanTargetDeviance~conditType,detailed=TRUE)
exp1.Test %>% group_by(positionX) %>%dunn_test(MeanTargetDeviance~conditType,detailed=TRUE)
exp1.Test %>% group_by(positionX) %>%tukey_hsd(MeanTargetDeviance~conditType,detailed=TRUE)



exp1.Test %>% filter(ThrowPosition=="Constant Location") %>% anova_test(dv=MeanTargetDeviance,between=conditType,wid=sbjCode,type=3)
exp1.Test %>% filter(ThrowPosition=="Novel Location") %>% anova_test(dv=MeanTargetDeviance,between=conditType,wid=sbjCode,type=3)
```





### Experiment 2 ###




# Experiment 2 - calculate various distances between transfer throw position and training throw position
```{r,echo=FALSE}


e2$stage <- factor(e2$stage, levels = c("Beginning", "Middle", "End","Transfer"),ordered = TRUE)

exp2TrainPosition <- e2  %>% filter(stage!="Transfer") %>%ungroup() %>% 
  group_by(sbjCode,Group2,conditType,trainHalf,positionX) %>% 
  summarise(MeanTargetDistance=mean(AbsDistFromCenter))%>% as.data.frame()

exp2TrainPosition3 <- e2  %>% filter(stage!="Transfer") %>%ungroup() %>% 
  mutate(globalAvg=mean(AbsDistFromCenter),globalSd=sd(AbsDistFromCenter)) %>% 
  group_by(sbjCode,positionX) %>% mutate(scaledDev = scaleVar(globalAvg,globalSd,AbsDistFromCenter)) %>%ungroup() %>%
  group_by(sbjCode,Group2,conditType,stage,positionX) %>% 
  summarise(MeanTargetDistance=mean(AbsDistFromCenter),MeanScaledDev=mean(scaledDev,trim=.05))%>% as.data.frame()

exp2Train <- e2  %>% filter(stage!="Transfer")  %>% 
  group_by(sbjCode,Group2,conditType,trainHalf) %>% 
  summarise(MeanTargetDistance=mean(AbsDistFromCenter)) %>% as.data.frame()

exp2Train3 <- e2  %>% filter(stage!="Transfer")  %>% ungroup() %>% 
  mutate(globalAvg=mean(AbsDistFromCenter),globalSd=sd(AbsDistFromCenter)) %>% 
  group_by(sbjCode,positionX) %>% mutate(scaledDev = scaleVar(globalAvg,globalSd,AbsDistFromCenter)) %>%ungroup() %>%
  group_by(sbjCode,Group2,conditType,stage) %>% 
  summarise(MeanTargetDistance=mean(AbsDistFromCenter),MeanScaledDev=mean(scaledDev,trim=.05)) %>% as.data.frame()

transfer <- filter(e2, stage=="Transfer") %>% droplevels() %>% select(-trainHalf,-initialVelocityY,ThrowPosition2)%>% ungroup()
transfer <- transfer %>% group_by(positionX) %>% mutate(globalAvg=mean(AbsDistFromCenter),globalSd=sd(AbsDistFromCenter)) %>% 
  group_by(sbjCode,positionX) %>% mutate(scaledDev = scaleVar(globalAvg,globalSd,AbsDistFromCenter)) %>%ungroup()

transfer <- transfer %>% group_by(sbjCode,positionX) %>% mutate(ind=1,testPosIndex=cumsum(ind),posN=max(testPosIndex)) %>%
  select(-ind) %>% mutate(testHalf = case_when(testPosIndex<15 ~"1st Half",testPosIndex>=15 ~"2nd Half")) %>% convert_as_factor(testHalf)

variedTest <- transfer %>% filter(condit==7) %>% mutate(extrapolate=ifelse(positionX=="900" | positionX=="400","extrapolation","interpolation")) 
constantTest <- transfer %>% filter(condit!=7) %>% mutate(extrapolate=ifelse(distFromTrain==0,"interpolation","extrapolation"))

transfer <- rbind(variedTest,constantTest)
transfer<- transfer %>% mutate(novel=ifelse(distFromTrain3==0,"trainedLocation","novelLocation"))%>% convert_as_factor(novel,extrapolate)

transfer <- transfer %>% relocate(sbjCode,condit2,Group,conditType2,stage,trial,novel,extrapolate,positionX,AbsDistFromCenter,globalAvg,globalSd,scaledDev,distFromTrain3) %>% ungroup()


# novelAll <- transfer %>% filter(distFromTrain!=0, distFromTrain3!=0) %>% select(-globalAvg,-globalSd,-scaledDev)%>% droplevels() %>% ungroup()
# novelAll <- novelAll %>% group_by(positionX) %>%
#  mutate(globalAvg=mean(AbsDistFromCenter),globalSd=sd(AbsDistFromCenter)) %>% 
#   group_by(sbjCode,positionX) %>% mutate(scaledDev = scaleVar(globalAvg,globalSd,AbsDistFromCenter)) %>%ungroup()

novelAll <- transfer %>% filter(distFromTrain!=0, distFromTrain3!=0)
novelAllMatched <- novelAll %>% filter(condit!=5,condit!=2)


constantIden <- transfer %>% filter(condit !=7,distFromTrain==0) # only constant groups from their training position
variedTest <- transfer %>% filter(condit==7) # only varied testing
variedVsIden <- rbind(constantIden,variedTest) # all varied combined with constant identity


variedNovel <- variedTest %>% filter(distFromTrain3 !=0) # removes 500 and 800 from varied
constantIden2 <- transfer %>% filter(condit !=7,condit!=5,condit!=2,distFromTrain==0) # only constant groups from training position 400,625,675,900
variedVsNovelIden <- rbind(constantIden2,variedNovel) # novel positions for varied, trained for constant

exp2.Test <- transfer %>%group_by(sbjCode,conditType,positionX,ThrowPosition)%>%
  summarise(MeanTargetDeviance = mean(AbsDistFromCenter,trim=.05),MeanScaledDev=mean(scaledDev,trim=.05)) %>%ungroup() %>% as.data.frame()

exp2.Test2 <- exp2.Test %>% group_by(sbjCode,conditType)%>%
  summarise(MeanTargetDeviance = mean(MeanTargetDeviance),MeanScaledDev=mean(MeanScaledDev)) %>%ungroup() %>% as.data.frame()

exp2.Test7 <- transfer %>%group_by(Group2,sbjCode,positionX,Group,conditType,ThrowPosition4) %>% 
  summarise(MeanTargetDeviance = mean(AbsDistFromCenter,trim=.05),MeanScaledDev=mean(scaledDev,trim=.05)) %>% as.data.frame()

exp2.Test7.agg <- exp2.Test7  %>%group_by(Group2,sbjCode,Group,conditType) %>% 
  summarise(MeanTargetDeviance = mean(MeanTargetDeviance),MeanScaledDev=mean(MeanScaledDev)) %>% as.data.frame()

exp2.Test7.agg2 <- exp2.Test7  %>%group_by(sbjCode,conditType) %>% 
  summarise(MeanTargetDeviance = mean(MeanTargetDeviance),MeanScaledDev=mean(MeanScaledDev)) %>% as.data.frame()

```


# Training - Experiment 2
```{r}


# Original Manuscript figures 5a and 5b - 2 training halves
exp2TrainPosition %>% ggplot(aes(x=trainHalf,y=MeanTargetDistance))+
  geom_bar(aes(group=trainHalf,fill=trainHalf),stat="summary",position=dodge,fun="mean")+
  stat_summary(aes(x=trainHalf,group=trainHalf),fun.data=mean_se,geom="errorbar",position=dodge,width=.8)+facet_wrap(~conditType,ncol=2)+
  ylab("Mean Distance From Center Of Target") +xlab("Training Stage")+theme(plot.title = element_text(hjust = 0.5))+guides(fill=guide_legend(title="Training Stage"))+theme(legend.title.align=.25)

exp2TrainPosition %>% ggplot(aes(x=positionX,y=MeanTargetDistance))+
  geom_bar(aes(group=trainHalf,fill=trainHalf),stat="summary",position=dodge,fun="mean")+
  facet_wrap(~conditType,ncol=2)+stat_summary(aes(x=positionX,group=trainHalf),fun.data=mean_se,geom="errorbar",position=dodge,width=.8)+ylab("Mean Distance From Center Of Target") +xlab("Training Location(s)")+theme(plot.title = element_text(hjust = 0.5))+guides(fill=guide_legend(title="Training Stage"))+theme(legend.title.align=.25)

### New - 3 stage
exp2TrainPosition3 %>% ggplot(aes(x=stage,y=MeanTargetDistance))+
  geom_bar(aes(group=stage,fill=stage),stat="summary",position=dodge,fun="mean")+
  stat_summary(aes(x=stage,group=stage),fun.data=mean_se,geom="errorbar",position=dodge,width=.8)+facet_wrap(~conditType,ncol=2)+
  ylab("Mean Distance From Center Of Target") +xlab("Training Stage")+theme(plot.title = element_text(hjust = 0.5))+guides(fill=guide_legend(title="Training Stage"))+theme(legend.title.align=.25)

exp2TrainPosition3 %>% ggplot(aes(x=positionX,y=MeanTargetDistance))+
  geom_bar(aes(group=stage,fill=stage),stat="summary",position=dodge,fun="mean")+
  facet_wrap(~conditType,ncol=2)+stat_summary(aes(x=positionX,group=stage),fun.data=mean_se,geom="errorbar",position=dodge,width=.8)+ylab("Mean Distance From Center Of Target") +xlab("Training Location(s)")+theme(plot.title = element_text(hjust = 0.5))+guides(fill=guide_legend(title="Training Stage"))+theme(legend.title.align=.25)

### New - comparison for Reviewer 3
exp2TrainPosition3 %>% filter(positionX=="500" | positionX=="800") %>% ggplot(aes(x=conditType,y=MeanTargetDistance))+
  geom_bar(aes(group=stage,fill=stage),stat="summary",position=dodge,fun="mean")+
  facet_wrap(~positionX,ncol=2)+stat_summary(aes(x=conditType,group=stage),fun.data=mean_se,geom="errorbar",position=dodge,width=.8)+ylab("Mean Distance From Center Of Target") +xlab("Training Condition")+theme(plot.title = element_text(hjust = 0.5))+guides(fill=guide_legend(title="Training Stage"))+theme(legend.title.align=.25)


# original
model<-ezANOVA(exp2Train,dv=MeanTargetDistance,within=c(trainHalf),between=conditType,wid=sbjCode,type=3);show(model)
model<-exp2Train %>% anova_test(dv=MeanTargetDistance,within=trainHalf,between=conditType,wid=sbjCode,type=3);show(model)

# new - 3 stage
model<-exp2Train3 %>% anova_test(dv=MeanTargetDistance,within=stage,between=conditType,wid=sbjCode,type=3);show(model)

# new - direct comparison
m1=exp2Train3%>% filter(Group2=="Position 500" | Group2=="Position 800" | Group2=="Position 500 and 800") %>% anova_test(dv=MeanScaledDev,within=stage,between=conditType,wid=sbjCode,type=3);show(m1)



t<- e2  %>% filter(stage!="Transfer") %>%ungroup()  %>% rename(Condition="conditType") %>% group_by(Condition,ThrowPosition) %>% 
  summarise(Mean=round(mean(AbsDistFromCenter),2),sd=round(sd(AbsDistFromCenter),2),msd=paste(Mean,"(",sd,")",sep=""),.groups="keep") %>%
   select(-Mean,-sd) %>% spread(ThrowPosition,msd) %>% as.data.frame() %>%stargazer(.,type="text",summary=FALSE,rownames = FALSE)
t<- e2  %>% filter(stage!="Transfer") %>%ungroup()  %>% rename(Condition="conditType") %>% group_by(Group,ThrowPosition) %>% 
  summarise(Mean=round(mean(AbsDistFromCenter),2),sd=round(sd(AbsDistFromCenter),2),msd=paste(Mean,"(",sd,")",sep=""),.groups="keep") %>%
   select(-Mean,-sd) %>% spread(ThrowPosition,msd) %>% as.data.frame() %>%stargazer(.,type="text",summary=FALSE,rownames = FALSE)

```

#temp
```{r}

exp2TrainPosition3 %>% filter(positionX=="500" | positionX=="800") %>% ggplot(aes(x=conditType,y=MeanTargetDistance))+
  geom_bar(aes(group=stage,fill=stage),stat="summary",position=dodge,fun="mean")+
  facet_wrap(~positionX,ncol=2)+stat_summary(aes(x=conditType,group=stage),fun.data=mean_se,geom="errorbar",position=dodge,width=.8)+ylab("Mean Distance From Center Of Target") +xlab("Training Condition")+theme(plot.title = element_text(hjust = 0.5))+guides(fill=guide_legend(title="Training Stage"))+theme(legend.title.align=.25)+
  ggtitle("IGAS training performance E2 - only common position")


```




#Experiment 2 - Testing Phase - General Comparison
```{r,fig.height=6,fig.width=7}
# manuscript plot
exp2.Test %>% ggplot(aes(x=ThrowPosition,y=MeanTargetDeviance,group=conditType,fill=conditType))+geom_bar(stat="summary",position=dodge,fun.y="mean")+ stat_summary(fun.data=mean_se,geom="errorbar",position=dodge,width=.5)+ylab("Mean Distance From Center Of Target") +xlab("Testing Location")+theme(plot.title = element_text(hjust = 0.5))+guides(fill=guide_legend(title="Training Condition"))+theme(legend.title.align=.25)

# manuscript analysis
mg2=exp2.Test2 %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,type=3);show(mg2) 

#other
model<-ezANOVA(data=exp2.Test,dv=MeanTargetDeviance,within=ThrowPosition,between=conditType,wid=sbjCode,type=3);show(model)
mg1=exp2.Test %>% anova_test(dv=MeanTargetDeviance,between=conditType,wid=sbjCode,within=positionX,type=3);show(mg1)



t<- exp2.Test %>% rename(Condition="conditType") %>% group_by(Condition,ThrowPosition) %>% 
  summarise(Mean=round(mean(MeanTargetDeviance),2),sd=round(sd(MeanTargetDeviance),2),msd=paste(Mean,"(",sd,")",sep=""),.groups="keep") %>%
   select(-Mean,-sd) %>% spread(ThrowPosition,msd) %>% as.data.frame() %>%stargazer(.,type="text",summary=FALSE,rownames = FALSE)



cnames=c("Condition","400","500","625","675","800","900","")
test= exp2.Test %>% rename(Condition="conditType") %>% group_by(Condition,ThrowPosition) %>% 
  summarise(Mean=round(mean(MeanTargetDeviance),2),sd=round(sd(MeanTargetDeviance),2)) 
test=test %>% group_by(Condition) %>% mutate(GroupAvg=round(mean(Mean),2),groupSd=round(sd(Mean),2))
test = test %>% mutate(msd=paste(Mean,"(",sd,")",sep=""),gsd=paste(GroupAvg,"(",groupSd,")",sep="")) %>% select(Condition,ThrowPosition,msd,gsd)%>%pivot_wider(names_from = ThrowPosition,values_from=c(msd,gsd))
test=test[,1:8] %>% as.data.frame()
colnames(test) <- cnames
stargazer(test,type="text",summary=FALSE,rownames=FALSE)

exp2.Test %>% group_by(positionX) %>% anova_test(MeanTargetDeviance~conditType)

```



# Experiment 2 - Testing Showing all 7 Groups
```{r}

exp2.Test7 %>% ggplot(aes(x=positionX,y=MeanTargetDeviance,group=Group2,fill=Group2))+geom_bar(stat="summary",position=position_dodge(),fun.y="mean")+ stat_summary(fun.data=mean_se,geom="errorbar",position=position_dodge())+ylab("Mean Distance From Center Of Target") +xlab("Testing Location")+theme(plot.title = element_text(hjust = 0.5))+guides(fill=guide_legend(title="Training Position"))+theme(legend.title.align=.25)

exp2.Test7 %>% 
  ggplot(aes(x=Group,y=MeanTargetDeviance,group=conditType,fill=conditType))+
  geom_bar(stat="summary",position=position_dodge(),fun="mean")+ 
  stat_summary(fun.data=mean_se,geom="errorbar",position=position_dodge())+
  facet_wrap(~ThrowPosition4)+
  ylab("Mean Distance From Center Of Target")+theme(plot.title = element_text(hjust = 0.5))+
  guides(fill=guide_legend(title="Training Condition"))+
  theme(legend.title.align=.25)+
  scale_x_discrete(name=" Training Group",labels=e2Labels)

exp2.Test7.agg %>% ggplot(aes(x=Group,y=MeanTargetDeviance,group=conditType,fill=conditType))+geom_bar(stat="summary",position=dodge,fun="mean")+ stat_summary(fun.data=mean_se,geom="errorbar",position=dodge,width=.5)+ylab("Mean Distance From Center Of Target") +
  theme(plot.title = element_text(hjust = 0.5))+guides(fill=guide_legend(title="Training Condition"))+theme(legend.title.align=.25)+scale_x_discrete(name="Training Group",labels=e2Labels)

my.contrasts.SAS <- list(Group=contr.SAS,positionX=contr.poly)
my.contrasts.Sum <- list(Group=contr.sum,positionX=contr.poly)
options(contrasts = c("contr.SAS", "contr.poly"))
options(contrasts = c("contr.sum", "contr.poly"))

model<-ezANOVA(data=exp2.Test7,dv=MeanTargetDeviance,between=c(Group2),within=positionX,wid=sbjCode); show(model)
model<-ezANOVA(data=exp2.Test7,dv=MeanScaledDev,between=Group,wid=sbjCode); show(model)

m2 = exp2.Test7 %>% anova_test(dv=MeanTargetDeviance,between=Group,wid=sbjCode,within=c(positionX)); show(m2)
m2 = exp2.Test7 %>% anova_test(dv=MeanScaledDev,between=Group,wid=sbjCode,within=c(positionX)); show(m2)

model<-ezANOVA(data=exp2.Test7,dv=MeanScaledDev,between=Group,wid=sbjCode); show(model)

m3=exp2.Test7 %>% anova_test(dv=MeanScaledDev,between=Group,wid=sbjCode,type=3); show(m3)
#m3=exp2.Test7 %>% anova_test(dv=MeanTargetDeviance,between=Group,wid=sbjCode,type=3); show(m3)

m4=exp2.Test7.agg %>% anova_test(dv=MeanScaledDev,between=Group,type=3); show(m4)
m5=exp2.Test7.agg2 %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,type=3); show(m5)
model<-ezANOVA(data=exp2.Test7.agg2,dv=MeanScaledDev,between=conditType,wid=sbjCode); show(model)



tt <-  exp2.Test7 %>% t_test(MeanScaledDev~Group,ref.group = "Varied-500_800"); show(tt)
exp2.Test7.agg %>% t_test(MeanScaledDev~Group,ref.group = "Varied-500_800")

exp2.Test7 %>% tukey_hsd(MeanScaledDev~Group)


exp2.Test7 %>% lm(MeanScaledDev ~ Group,data=.) %>% summary()
exp2.Test7 %>% lm(MeanScaledDev ~ Group+positionX,data=.) %>% summary()
exp2.Test7 %>% aov(MeanScaledDev~Group,data=.,contrasts=my.contrastsSAS) %>% summary()
exp2.Test7 %>% aov(MeanScaledDev~Group,data=.,contrasts=my.contrastsSum) %>% summary()

exp2.Test7 %>% aov(MeanScaledDev~Group,data=.,contrasts=my.contrasts) %>% summary()




exp2.Test7 %>%lmer(MeanScaledDev ~ Group +(1|positionX),data=.) %>% summary()
exp2.Test7 %>%lmer(MeanScaledDev ~ Group +(1|positionX)+(1|sbjCode),data=.,contrasts=my.contrasts.Sum) %>% summary()


#exp2.Test7 %>% group_by(positionX) %>%tukey_hsd(MeanTargetDeviance~Group,detailed=TRUE)
# exp2Transfer4  %>% group_by(positionX) %>%tukey_hsd(MeanTargetDeviance~Group2,detailed=TRUE)
# relevel( x = exp2Transfer4$Group2, ref = "Position 500 and 800" )
# exp2Transfer4 %>% lm(MeanTargetDeviance~Group2 + Error(sbjCode/Group2),data=.) %>% summary.lm()

 options(contrasts = c("contr.sum", "contr.poly"))
my.contrasts.Sum <- list(Group=contr.sum,positionX=contr.poly)

```




# Experiment 2  - only novel positions
```{r}
sum.novelAll <- novelAll %>% group_by(sbjCode,conditType,positionX) %>% 
  summarise(MeanTargetDev=mean(AbsDistFromCenter,trim=.05),MeanScaledDev=mean(scaledDev,trim=.05),.groups="keep") %>% as.data.frame()

sum.novelAll2 <- sum.novelAll %>% group_by(sbjCode,conditType) %>% 
  summarise(MeanTargetDev=mean(MeanTargetDev),MeanScaledDev=mean(MeanScaledDev),.groups="keep") %>% as.data.frame()

model3<-ezANOVA(data=sum.novelAll2,dv=MeanScaledDev,between=c(conditType),wid=sbjCode,type=3); show(model3)
mn2=sum.novelAll2 %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,type=3);show(mn2)

# mn=sum.novelAll %>% anova_test(dv=MeanTargetDev,between=conditType,within = positionX,wid=sbjCode,type=3);show(mn)

t<- sum.novelAll %>% rename(Condition="conditType") %>% group_by(Condition,positionX) %>% 
  summarise(Mean=round(mean(MeanTargetDev),2),sd=round(sd(MeanTargetDev),2),msd=paste(Mean,"(",sd,")",sep=""),.groups="keep") %>%
   select(-Mean,-sd) %>% spread(positionX,msd) %>% as.data.frame() %>%stargazer(.,type="text",summary=FALSE,rownames = FALSE)

test=sum.novelAll %>% rename(Condition="conditType") %>% group_by(Condition,positionX) %>% 
  summarise(Mean=round(mean(MeanTargetDev),2),sd=round(sd(MeanTargetDev),2),msd=paste(Mean,"(",sd,")",sep=""),.groups="keep") %>%
   select(-Mean,-sd) %>% spread(positionX,msd) %>% as.data.frame()

cnames=c("Condition","400","500","625","675","800","900","")
test=sum.novelAll %>% rename(Condition="conditType") %>% group_by(Condition,positionX) %>% 
  summarise(Mean=round(mean(MeanTargetDev),2),sd=round(sd(MeanTargetDev),2)) 
test=test %>% group_by(Condition) %>% mutate(GroupAvg=round(mean(Mean),2),groupSd=round(sd(Mean),2))
test = test %>% mutate(msd=paste(Mean,"(",sd,")",sep=""),gsd=paste(GroupAvg,"(",groupSd,")",sep="")) %>% select(Condition,positionX,msd,gsd)%>%pivot_wider(names_from = positionX,values_from=c(msd,gsd))
test=test[,1:8] %>% as.data.frame()
colnames(test) <- cnames
stargazer(test,type="text",summary=FALSE,rownames=FALSE)


##################


```





# Experiment 2 - Testing Stage - Varied vs. Constant identity - trained position for constant, novel for varied
```{r}
sum.variedVsNovelIden <- variedVsNovelIden  %>%
  group_by(sbjCode,conditType,positionX) %>% 
  summarise(MeanTargetDev=mean(AbsDistFromCenter,trim=.05),MeanScaledDev=mean(scaledDev,trim=.05)) %>% as.data.frame()

sum.variedVsNovelIden2 <- sum.variedVsNovelIden %>%
  group_by(sbjCode,conditType) %>% 
  summarise(MeanTargetDev=mean(MeanTargetDev,trim=.05),MeanScaledDev=mean(MeanScaledDev))%>% as.data.frame()

mi4=sum.variedVsNovelIden2 %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,type=3);show(mi4)



cnames=c("Condition","400","625","675","900","")
test=sum.variedVsNovelIden %>% rename(Condition="conditType") %>% group_by(Condition,positionX) %>% 
  summarise(Mean=round(mean(MeanTargetDev),2),sd=round(sd(MeanTargetDev),2)) 
test=test %>% group_by(Condition) %>% mutate(GroupAvg=round(mean(Mean),2),groupSd=round(sd(Mean),2))
test = test %>% mutate(msd=paste(Mean,"(",sd,")",sep=""),gsd=paste(GroupAvg,"(",groupSd,")",sep="")) %>% select(Condition,positionX,msd,gsd)%>%pivot_wider(names_from = positionX,values_from=c(msd,gsd))
test=test[,1:6] %>% as.data.frame()
colnames(test) <- cnames

stargazer(test,type="text",summary=FALSE,rownames=FALSE)


kable(test)



sum.variedVsNovelIden %>% ggplot(aes(x=positionX,y=MeanTargetDev,group=conditType,fill=conditType))+geom_bar(stat="summary",position=dodge,fun.y="mean")+ stat_summary(fun.data=mean_se,geom="errorbar",position=dodge,width=.5)+ylab("Mean Distance From Center Of Target") +xlab("Testing Location")+theme(plot.title = element_text(hjust = 0.5))+guides(fill=guide_legend(title="Training Condition"))+theme(legend.title.align=.25)
 
```









### re-doing experiment 2 comparisons while controlling for similarity (1c) ###



# Task Space Visualization
```{r}
library("RColorBrewer")
taskspace <- e2 %>% filter(AbsDistFromCenter<900)
taskspace$hitOrMiss <- ifelse(taskspace$trialType==11,"Hit Target","Missed Target")
taskspace %>% ggplot(aes(x=X_Velocity,y=Y_Velocity)) + geom_point(aes(colour=trialType2),alpha=0.5) + ggtitle(" Experiment 2. Example of full task space - Position 900")

taskspace %>% ggplot(aes(x=X_Velocity,y=Y_Velocity)) + geom_point(aes(colour=hitOrMiss),alpha=0.5) 
solSpace <- e2 %>% filter(trialType==11)
#solSpace %>% ggplot(aes(x=X_Velocity,y=Y_Velocity)) + geom_point(aes(colour=ThrowPosition),alpha=0.58) + ggtitle("") 

solSpace$Result = ifelse(solSpace$ThrowPosition==400,"400",solSpace$ThrowPosition)
solSpace$Result = ifelse(solSpace$ThrowPosition==500,"500",solSpace$Result)
solSpace$Result= ifelse(solSpace$ThrowPosition==625,"625",solSpace$Result)
solSpace$Result = ifelse(solSpace$ThrowPosition==675,"675",solSpace$Result)
solSpace$Result = ifelse(solSpace$ThrowPosition==800,"800",solSpace$Result)
solSpace$Result = ifelse(solSpace$ThrowPosition==900,"900",solSpace$Result)


missSpace <- e2 %>% filter(trialType !=11)
missSpace$Result = "Missed Target"
solSpace$Result <- solSpace$Result

# the usual method of changing the legend title does not seem to work after the colours are manually scaled. 
# multiplied velocoties by -1 to make the axes less confusing
solSpace %>% ggplot(aes(x=X_Velocity*-1,y=Y_Velocity*-1)) + geom_point(aes(colour=Result),alpha=0.6) + scale_color_manual(values =brewer.pal(n=6,name="Set1"))+labs(colour="Target Hit Thrown from Position:") + xlab("X Release Velocity") + ylab("Y Release Velocity")
fullSpace <- rbind(missSpace,solSpace)

fullSpace %>% ggplot(aes(x=X_Velocity*-1,y=Y_Velocity*-1,colour=Result)) + geom_point(aes(),alpha=0.6) + scale_color_manual(values =brewer.pal(n=7,name="Set1"))+labs(colour="Target Hit or Miss From Position:") + xlab("X Release Velocity") + ylab("Y Release Velocity") 
```




# effect of similarity
```{r}

dSim <- readRDS(paste0("model_fits/group_fits/",list.files(path="model_fits/group_fits/",pattern = "info_*")))$objects$e2Sim

transferSim <- merge(exp2.Test,dSim,by=c("sbjCode","conditType","positionX")) %>% as.data.frame()

transferSim2 <- transferSim %>% ungroup() %>% 
  group_by(sbjCode,conditType) %>% 
  summarise(MeanTargetDeviance=mean(MeanTargetDeviance),MeanScaledDev=mean(MeanScaledDev),sim_c=mean(sim_c),sim_cv=mean(sim_cv)) %>% 
  ungroup() %>% as.data.frame()




lm.sim=dSim %>% lm(deviation ~ sim_c, data=.);summary(lm.sim)

# lmm.sim <- transferSim %>% lmer(deviation ~ sim_c + (1|positionX)+ (1|sbjCode)+(1|conditType),data=.)
# summary(lmm.sim)
# MuMIn::r.squaredGLMM(lmm.sim)
# dSim %>% cor_test(dev, sim_c, method = "pearson")
# anova_test(lm.sim)

```


# general comparison - with similarity
```{r}

#m5=transferSim %>% anova_test(dv=MeanScaledDev,between=conditType,covariate=sim_c,wid=sbjCode,type=3);show(m5)

# 
# transferSim %>% lmer(MeanScaledDev ~ conditType+sim_c + (1|sbjCode)+(1|positionX),data=.) %>% anova()
# model<-ezANOVA(data=transferSim,dv=MeanScaledDev,between=conditType,within_covariates = sim_c,wid=sbjCode); show(model)


# m5=transferSim %>% anova_test(dv=MeanTargetDeviance,between=conditType,within=positionX,covariate=sim_c,wid=sbjCode);show(m5)
# transferSim %>% lmer(MeanTargetDeviance ~ conditType+sim_c + (1|sbjCode),data=.) %>% anova()

m6r=transferSim2 %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,type=3);show(m6r)
m6=transferSim2 %>% anova_test(dv=MeanScaledDev,between=conditType,covariate=sim_c,wid=sbjCode,type=3);show(m6)

# 
# m6r <- lm(MeanScaledDev~conditType,data=transferSim2)
# m6 <- lm(MeanScaledDev~conditType+sim_c,data=transferSim2); summary(m6)
# car::Anova(m6,type=2)
# anova(m6r,m6)

```






## varied vs constant identity - (not 500 or 800) - while controlling for sim ##
```{r}

sum.variedVsNovelIden <- variedVsNovelIden %>% 
  group_by(sbjCode,conditType,positionX) %>% 
  summarise(MeanTargetDev=mean(AbsDistFromCenter,trim=.05),MeanScaledDev=mean(scaledDev,trim=.05)) 

idenSimPos <- merge(sum.variedVsNovelIden,dSim,by=c("sbjCode","conditType","positionX")) %>% group_by(sbjCode,conditType,positionX) %>%summarise(MeanTargetDev=mean(MeanTargetDev),MeanScaledDev=mean(MeanScaledDev),sim_c=mean(sim_c),sim_cvcc=mean(sim_cv)) %>%ungroup() %>% as.data.frame()

idenSim <- idenSimPos %>% group_by(sbjCode,conditType) %>%
  summarise(MeanTargetDev=mean(MeanTargetDev),MeanScaledDev=mean(MeanScaledDev),sim_c=mean(sim_c),sim_cvcc=mean(sim_cvcc)) %>%ungroup() %>% as.data.frame()





m8 <- idenSim %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,covariate = sim_c,type=3);show(m8)


# MuMIn::r.squaredGLMM(m8)
# idenSimPos %>% lmer(MeanTargetDev ~ conditType+sim_c + (1|sbjCode),data=.) %>% anova()
# lm8 <- idenSimPos %>% lmer(MeanTargetDev ~ conditType+sim_c + (1|sbjCode)+(1|positionX),data=.) 
# MuMIn::r.squaredGLMM(lm8)
# r2glmm::r2beta(lm8)
# 
# 
# idenSimPos %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,covariate = sim_c,type=3)
# idenSimPos %>% anova_test(dv=MeanTargetDev,between=conditType,wid=sbjCode,covariate = c(sim_c,positionX),type=3)




# table
# idenSimPos %>% group_by(conditType,positionX) %>% get_summary_stats(MeanTargetDev,type="common")
# idenSimPos %>% group_by(conditType,positionX) %>% get_summary_stats(MeanTargetDev,type="mean_sd")
# m6ir <- lm(MeanScaledDev~conditType,data=idenSim)
# m6i <- lm(MeanScaledDev~conditType+sim_c,data=idenSim); summary(m6i)
# anova(m6r,m6)



```



# Model Comparison - can Similarity2c account for the effect of varied training?
```{r}
e2Models <- readRDS(paste0("model_fits/group_fits/",list.files(path="model_fits/group_fits/",pattern = "info_*")))$models
anova(e2Models$c_Only.G,e2Models$c_Condit.G) # 2nd model adds conditType, sig. improvement
anova(e2Models$cv_Only.G,e2Models$cv_Condit.G) # 2nd model adds conditType, No sig. improvement
# compare BIC between model 1 and model 3
BIC(e2Models$c_Only.G,e2Models$cv_Only.G) # c=14604.0; cv=14587.64
```









######## Extra, not in manuscript ########





#Experiment 2 - extrapolation - within-group varied
```{r}
sum.variedExt <- transfer %>% filter (conditType2=="Varied Training") %>% droplevels() %>% group_by(sbjCode,positionX,extrapolate) %>% summarise(MeanTargetDev=mean(AbsDistFromCenter),MeanScaledDev=mean(scaledDev)) %>%as.data.frame()# categorize varied testing positions as interpolation vs. extrapolation

sum.variedExt2 <- transfer %>% filter (conditType2=="Varied Training") %>% droplevels() %>% group_by(sbjCode,extrapolate) %>% summarise(MeanTargetDev=mean(AbsDistFromCenter),MeanScaledDev=mean(scaledDev)) %>%as.data.frame() # categorize varied testing positions as interpolation vs. extrapolation


m12 <- sum.variedExt2 %>% anova_test(dv=MeanScaledDev,wid=sbjCode,within=extrapolate)
show(m12)


sum.variedExt2 %>% t_test(MeanScaledDev~extrapolate,paired=TRUE)


model<-ezANOVA(data=sum.variedExt,dv=MeanTargetDev,within=.(extrapolate),wid=sbjCode,type=3) 
show(model)

sm<-ezANOVA(data=sum.variedExt,dv=MeanScaledDev,within=.(extrapolate),wid=sbjCode,type=3) 
show(sm)


model<-ezANOVA(data=sum.variedExt,dv=MeanTargetDev,within=.(extrapolate),within_covariates(positionX),wid=sbjCode,type=1) 
show(model)

lm.extInt = sum.variedExt %>% lmer(MeanTargetDev ~ extrapolate+ +(1|positionX)+(1|sbjCode),data=.)
summary(lm.extInt)
anova(lm.extInt,type=1)


sum.variedExt2 %>% anova_test(dv=MeanTargetDev,within=extrapolate,wid=sbjCode)

```





#Experiment 2 - general comparison with an extrapolation factor
```{r}
# sbjCheck <- transfer %>% ungroup() %>% group_by(sbjCode,Group,conditType2,extrapolate,positionX) %>% 
#   summarise(n=n()) %>%ungroup() %>% group_by(sbjCode,Group,conditType2,extrapolate) %>% summarise(nPos=n()) %>% arrange(conditType2,nPos)
# 
# extInt <- transfer %>% group_by(sbjCode,conditType,positionX,extrapolate) %>% 
#   summarise(MeanTargetDeviance = mean(AbsDistFromCenter,trim=.05),MeanScaledDev=mean(scaledDev,trim=.05)) %>% ungroup()%>% as.data.frame()
# extInt2 <- extInt %>% group_by(sbjCode,conditType,extrapolate) %>% 
#   summarise(MeanTargetDeviance = mean(MeanTargetDeviance),MeanScaledDev=mean(MeanScaledDev)) %>% ungroup() %>% as.data.frame()
# 
# extInt2 %>% anova_test(dv=MeanScaledDev,within=extrapolate,wid=sbjCode)
# extInt2 %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode)
# 
# # m9 <- extInt2 %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,within=extrapolate,type=3)
# # show(m9)
# 
# m9 <- extInt2 %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,covariate=extrapolate,type=3)
# show(m9)
# 
# 
# t<- extInt2 %>% rename(Condition="conditType") %>% group_by(Condition,extrapolate) %>% 
#   summarise(Mean=round(mean(MeanTargetDeviance),2),sd=round(sd(MeanTargetDeviance),2),msd=paste(Mean,"(",sd,")",sep=""),.groups="keep") %>%
#    select(-Mean,-sd) %>% spread(extrapolate,msd) %>% as.data.frame() %>%stargazer(.,type="text",summary=FALSE,rownames = FALSE)


# m10 <- extInt %>% anova_test(dv=MeanTargetDeviance,between=conditType,wid=sbjCode,covariate=c(extrapolate,positionX),type=3)
# show(m10)
# 
# extInt %>% group_by(positionX) %>%tukey_hsd(MeanTargetDeviance~conditType,detailed=TRUE)
# extInt %>% group_by(positionX) %>% welch_anova_test(MeanTargetDeviance~conditType) 
# 
# options(contrasts = c("contr.sum", "contr.poly"))
# extInt %>%group_by(extrapolate) %>% anova_test(dv=MeanTargetDeviance,between=conditType,wid=sbjCode,type=3)
# extInt2 %>%group_by(extrapolate) %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,type=3)
# 
# # modelExInt<- extInt %>% ezANOVA(dv=MeanTargetDeviance,within_covariates=.(positionX,extrapolate),between=c(conditType2),wid=sbjCode,data=.,type=3) 
# # show(modelExInt)
# # 
# # modelExInt2<- extInt2 %>% ezANOVA(dv=MeanScaledDev,within=.(extrapolate),between=c(conditType),wid=sbjCode,data=.,type=3) 
# # show(modelExInt2)
# # 
# lm.extInt = extInt %>% lmer(MeanTargetDeviance ~ extrapolate*conditType +(1|positionX)+(1|sbjCode),data=.)
# summary(lm.extInt)
# # anova(lm.extInt,type=3)
# 
# lm.extInt = extInt2 %>% lmer(MeanScaledDev ~ extrapolate*conditType +(1|sbjCode),data=.)
# summary(lm.extInt)
# anova(lm.extInt,type=3)

```






```{r}

# 
# extOnly1 <- transfer %>% filter((positionX==400 | positionX==900)) %>% group_by(sbjCode,conditType,positionX,Group) %>% 
#   summarise(MeanTargetDeviance = mean(AbsDistFromCenter,trim=.05),MeanScaledDev=mean(scaledDev,trim=.05)) %>% ungroup()%>% as.data.frame()
# 
# extOnly2 <- extOnly1 %>% group_by(sbjCode,conditType) %>% 
#   summarise(MeanTargetDeviance = mean(MeanTargetDeviance),MeanScaledDev=mean(MeanScaledDev)) %>% ungroup()%>% as.data.frame()
# 
# 
# meo <- extOnly1 %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,type=3)
# show(meo)
# 
# 
# meo2 <- extOnly2 %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,type=3)
# show(meo2)
# 
# 
# 
# extOnly3 <- transfer %>% filter((positionX==900),abs(distFromTrain3)<=100) %>% group_by(sbjCode,conditType,positionX,Group) %>% 
#   summarise(MeanTargetDeviance = mean(AbsDistFromCenter,trim=.05),MeanScaledDev=mean(scaledDev,trim=.01)) %>% ungroup()%>% as.data.frame()
# 
# meo <- extOnly3 %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,type=3)
# show(meo)
```








#Only varied extrapolation positions with groups 3 and 4, and only abs(distFromTrain)<=100
```{r}
# 
# 
# extOnly1 <- transfer %>% filter(condit!=3,condit!=4,(positionX==400 | positionX==900), abs(distFromTrain3)<=100) %>% group_by(sbjCode,conditType,positionX,Group) %>% 
#   summarise(MeanTargetDeviance = mean(AbsDistFromCenter,trim=.05),MeanScaledDev=mean(scaledDev,trim=.05)) %>% ungroup()%>% as.data.frame()
# 
# extOnly2 <- extOnly1 %>% group_by(sbjCode,conditType) %>% 
#   summarise(MeanTargetDeviance = mean(MeanTargetDeviance),MeanScaledDev=mean(MeanScaledDev)) %>% ungroup()%>% as.data.frame()
# 
# 
# meo <- extOnly1 %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,type=3)
# show(meo)
# 
# 
# meo2 <- extOnly2 %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,type=3)
# show(meo2)
```











# only novel positions - including sim in model
```{r}
# sum.novelAll <- novelAll %>% group_by(sbjCode,conditType,positionX) %>% summarise(MeanTargetDev=mean(AbsDistFromCenter),MeanScaledDev=mean(scaledDev,trim=.05))
# 
# novelSimPos <- merge(sum.novelAll,dSim,by=c("sbjCode","conditType","positionX")) %>% group_by(sbjCode,conditType,positionX) %>%
#   summarise(MeanTargetDev=mean(MeanTargetDev),MeanScaledDev=mean(MeanScaledDev),sim_c=mean(sim_c),sim_cvcc=mean(sim_cv)) %>%ungroup() %>% as.data.frame()
# 
# novelSim <- novelSimPos %>% group_by(sbjCode,conditType) %>%
#   summarise(MeanTargetDev=mean(MeanTargetDev),MeanScaledDev=mean(MeanScaledDev),sim_c=mean(sim_c),sim_cvcc=mean(sim_cvcc)) %>%ungroup() %>% as.data.frame()
# 
# m7 <- novelSim %>% anova_test(dv=MeanScaledDev,between=conditType,covariate = sim_c,wid=sbjCode,type=3);show(m7)
# lm7<-novelSimPos %>% lmer(MeanTargetDev ~ conditType+sim_c + (1|sbjCode)+(1|positionX),data=.) 
# anova(lm7)
# 
# MuMIn::r.squaredGLMM(lm7)
# r2glmm::r2beta(lm7,method="nsj")
# 
# 
# novelSimPos %>% filter(positionX!=500,positionX!=800)%>% lmer(MeanScaledDev ~ conditType+sim_c + (1|sbjCode),data=.) %>% anova()
# 
# 
# novelSim %>% emmeans_test(MeanScaledDev~conditType,p.adjust.method = "bonferroni")
# #novelSim %>% group_by(conditType) %>% emmeans_test(MeanScaledDev~sim_c,p.adjust.method = "bonferroni")
# novelSim %>% group_by(conditType) %>% anova_test(MeanScaledDev~sim_c)
# novelSimPos %>% group_by(positionX) %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode)
# 
# 
# 
# m6nr <- lm(MeanScaledDev~conditType,data=novelSim)
# m6n <- lm(MeanScaledDev~conditType+sim_c,data=novelSim); summary(m6n)
# anova(m6r,m6)

```





# training plot alternate
```{r}
# manuscript plots
# exp2Train %>% ggplot(aes(x=trainHalf,y=MeanTargetDistance))+
#   geom_bar(aes(group=positionX,fill=positionX),stat="summary",position=dodge)+
#   facet_wrap(~conditType,ncol=2)+
#   stat_summary(aes(x=trainHalf,group=positionX),fun.data=mean_se,geom="errorbar",position=dodge,width=.8)+
#   ylab("Mean Distance From Center Of Target")+
#   xlab("Training Stage")+theme(plot.title = element_text(hjust = 0.5))+
#   guides(fill=guide_legend(title="Throw Location"))+theme(legend.title.align=.25)




```


# only novel positions - matching positions btw varied and constant by excluding 800 and 500
```{r}
sum.novelAllMatched <- novelAll %>% filter(positionX!=800,positionX!=500) %>% group_by(sbjCode,conditType,positionX) %>% 
  summarise(MeanTargetDev=mean(AbsDistFromCenter),MeanScaledDev=mean(scaledDev,trim=.05),.groups="keep") %>% as.data.frame()

sum.novelAllMatched2 <- sum.novelAllMatched %>% group_by(sbjCode,conditType) %>% 
  summarise(MeanTargetDev=mean(MeanTargetDev),MeanScaledDev=mean(MeanScaledDev),.groups="keep") %>% as.data.frame()


mn3=sum.novelAllMatched %>% anova_test(dv=MeanTargetDev,between=conditType,within=positionX,wid=sbjCode,type=3);show(mn3)
mn4=sum.novelAllMatched2 %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode,type=3);show(mn4)
```




# Experiment 2  - novel vs trained as factor
```{r}
exp2.novelVsTrain <- transfer %>% filter () %>% group_by(sbjCode,conditType,positionX,novel) %>% summarise(MeanTargetDev=mean(AbsDistFromCenter),MeanScaledDev=mean(scaledDev)) %>%
  as.data.frame()# categorize varied testing positions as interpolation vs. extrapolation

exp2.novelVsTrain2 <- transfer %>% filter () %>% group_by(sbjCode,conditType,novel) %>% summarise(MeanTargetDev=mean(AbsDistFromCenter,trim=.05),MeanScaledDev=mean(scaledDev,trim=.05),.groups="keep") %>% as.data.frame


## novel vs trained effect

exp2.novelVsTrain2 %>% anova_test(dv=MeanScaledDev,within=novel,wid=sbjCode,type=3)
exp2.novelVsTrain2 %>% group_by(novel) %>% get_summary_stats(type="common")

exp2.novelVsTrain %>% lmer(MeanTargetDev ~ novel + (1|sbjCode)+(1|positionX),data=.) %>% summary
exp2.novelVsTrain %>% lmer(MeanTargetDev ~ novel + (1|sbjCode),data=.) %>% summary


exp2.novelVsTrain %>% group_by(conditType) %>% pairwise_t_test(MeanTargetDev~novel,paired=TRUE)
exp2.novelVsTrain %>% group_by(novel) %>%shapiro_test(MeanTargetDev)
########



m.NovelVsTrain <- exp2.novelVsTrain %>% ezANOVA(dv=MeanTargetDev,within=novel,between=conditType,wid=sbjCode,data=.,type=3) 
show(m.NovelVsTrain)

# can't do the full interaction with novel, since varied only has 1 value per position
m.NovelVsTrain <- exp2.novelVsTrain %>% 
  ezANOVA(dv=MeanTargetDev,between=conditType,within_full=(novel),within_covariates =(positionX),wid=sbjCode,data=.,type=3) 
show(m.NovelVsTrain)

lmn = exp2.novelVsTrain %>% lmer(MeanTargetDev ~ conditType+novel +(1|sbjCode)+(1|positionX) ,data=.)
summary(lmn)



m.NovelVsTrain2 <- exp2.novelVsTrain2 %>% 
  ezANOVA(dv=MeanScaledDev,within=(novel),between=conditType,wid=sbjCode,data=.,type=3) 
show(m.NovelVsTrain2)

lmn = exp2.novelVsTrain %>% lmer(MeanScaledDev ~ conditType*novel +(1|sbjCode) ,data=.)
summary(lmn)


exp2.novelVsTrain %>% anova_test(dv=MeanScaledDev,between=conditType,covariate=novel,wid=sbjCode,type=3)
exp2.novelVsTrain2 %>% anova_test(dv=MeanScaledDev,between=conditType,within=novel,wid=sbjCode,type=3)


```




# experiment 2 - Varied vs. identity - trained for constant, novel for varied
```{r}


sum.variedVsNovelIden <- variedVsNovelIden  %>%
  group_by(sbjCode,conditType,positionX) %>% 
  summarise(MeanTargetDev=mean(AbsDistFromCenter,trim=.05),MeanScaledDev=mean(scaledDev,trim=.05)) %>% 
  ungroup() %>% group_by(sbjCode,conditType) %>% 
  mutate(MeanTargetDev2=mean(MeanTargetDev),MeanScaledDev2=mean(MeanScaledDev)) %>% as.data.frame()

sum.variedVsNovelIden2 <- variedVsNovelIden %>%
  group_by(sbjCode,conditType) %>% 
  summarise(MeanTargetDev=mean(AbsDistFromCenter,trim=.05),MeanScaledDev=mean(scaledDev,trim=.05)) %>% as.data.frame()


sum.variedVsNovelIden2 %>% anova_test(dv=MeanScaledDev,between=conditType,wid=sbjCode)


sum.variedVsNovelIden %>% welch_anova_test(MeanTargetDev~conditType) 


# 
# model2<-ezANOVA(data=sum.variedVsNovelIden2,dv=MeanScaledDev,between=(conditType),wid=sbjCode,type=3)
# show(model2)
# 
# sum.variedVsNovelIden %>% anova_test(dv=MeanTargetDev,between=conditType,covariate=positionX,wid=sbjCode)

#devtools::install_github('bcjaeger/r2glmm')
library("r2glmm") # for computed effect size for individual predictors of mixed models - semi-partial (marginal) r squared

# 
# lmi <- sum.variedVsNovelIden %>% lmer(MeanTargetDev ~ conditType+positionX + (1|sbjCode),data=.)
# summary(lmi)
# r.squaredGLMM(lmi)
# r2beta(lmi,method="nsj")
 ami <- sum.variedVsNovelIden %>%afex::mixed(MeanTargetDev ~ conditType + (1|sbjCode) + (1|positionX),data=.,type=3)
 summary(ami)

# lt1 <- variedVsNovelIden %>% lmer(AbsDistFromCenter ~ conditType2*positionX+(1+positionX|sbjCode),data=.)
# summary(lt1)

```




```{r}
ts <- transfer %>% group_by(sbjCode,conditType,positionX) %>% summarise(MeanTargetDev=mean(AbsDistFromCenter),MeanScaledDev=mean(scaledDev))
ts2 <- transfer %>% group_by(sbjCode,conditType) %>% summarise(MeanTargetDev=mean(AbsDistFromCenter,trim=.05),MeanScaledDev=mean(scaledDev,trim=.05))

mt <-ezANOVA(data=ts ,dv=MeanScaledDev,between=c(conditType),within=positionX,wid=sbjCode,type=3) 
show(mt)
mt2 <-ezANOVA(data=ts2 ,dv=MeanScaledDev,between=c(conditType),wid=sbjCode,type=3) 
show(mt2)

```



```{r}

normTest <- exp1Transfer3 %>% group_by(conditType,positionX)%>% shapiro_test(MeanTargetDeviance) %>% mutate(pr <- round(p,4))

ggqqplot(exp1Transfer3,"MeanTargetDeviance",facet.by="conditType") # correlation between data and a normal distribution
ggqqplot(exp1Transfer3,"MeanTargetDeviance",facet.by=c("conditType","positionX")) # correlation between data and a normal distribution

pwc <- exp1Transfer3 %>% group_by(positionX) %>% pairwise_t_test(MeanTargetDeviance~conditType,paired=FALSE,p.adjust.method="bonferroni")
pwc <- pwc %>% add_xy_position(x="positionX")

bxp <- ggboxplot(exp1Transfer3, x = "positionX", y = "MeanTargetDeviance", add = "point",color="conditType")
bxp + 
  stat_pvalue_manual(pwc,tip.length=0,hide.ns=TRUE) +
  labs(subtitle = get_test_label(m1, detailed = TRUE),
    caption = get_pwc_label(pwc)
  )

```

